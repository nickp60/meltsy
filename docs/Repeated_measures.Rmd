---
title: "Untitled"
author: "Nick Waters"
date: "16/7/2018"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library( tidyr)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
data <- read.csv("../data/testdata.csv")
data$rep <- letters[(as.factor(data$rep))]
head(data)
# add in random pH values that dont fluctuate much
set.seed(1234)
data$pH <- rnorm(nrow(data), mean=7, sd=.5)
# and some random value for gas production: some amount added to the methan volume
data$gas <- data$methane + rnorm(nrow(data), mean=200, sd=100)

#write.table(data, file="./data/testdata.csv", row.names = F, sep = ",")
ggplot(data, aes(x=day, y=methane,  group=day)) + geom_violin() + geom_jitter() 

# reshape to tall data
tdata <- data %>% gather(key = "measure", value="value", c(4:ncol(data)))
#gran <- data %>% select(day, rep, treatment, methane) %>% spread(key = treatment, value=methane)
#granph <- data %>% select(day, rep, treatment, pH) %>% spread(key = treatment, value=pH)
```





```{r}
library(ggplot2)

#install.packages("lme4")
library(lme4)


ggplot(tdata, aes(y=value, x=day, color=treatment, fill=treatment, linetype=treatment, shape=treatment))+
  geom_smooth(alpha=.2)+ 
  geom_jitter(width = .1)  +
  facet_wrap(~measure, scales = "free")
str(data)
# basic linear regression, non-multilevel
ggplot(data, aes(x=day, y=methane, color=treatment)) + geom_smooth(method = "lm", formula = y~x) + geom_point()
# nonm <- lm(methane ~ day + treatment + rep, data = data)
#display(nonm)

m1 <- lmer("methane ~ day + treatment + (1| rep)", data=data, REML=FALSE)

m1 <- lmer(methane ~ day + treatment + (1| rep), data=data, REML=FALSE)
m2 <- lmer(methane ~ day  + (1| rep), data=data, REML=FALSE)

anova(m1, m2)
lmer(methane ~ day * treatment + 
                (time | treatment/rep), 
        data=df)


```


```
lmod <- lm(pH + methane ~ day, data)
sdscal <- sd(residuals(lmod))
Xmatrix <- model.matrix(lmod)
data$comb <- factor(paste(data$rep,data$treatment,sep="_"))
datdat <- list(Nobs=nrow(data),
               Npreds=ncol(Xmatrix),
               Nlev1=length(unique(data$rep)),
               Nlev2=length(unique(data$comb)),
               y=data$methane,
               x=Xmatrix,
               levind1=as.numeric(data$rep),
               levind2=as.numeric(data$comb),
               sdscal=sdscal)

```


```{r}
model_code = "
data {
     int<lower=0> Nobs;
     int<lower=0> Npreds;
     int<lower=0> Nlev1;
     int<lower=0> Nlev2;
     vector[Nobs] y;
     matrix[Nobs,Npreds] x;
     int<lower=1,upper=Nlev1> levind1[Nobs];
     int<lower=1,upper=Nlev2> levind2[Nobs];
     real<lower=0> sdscal;
}
parameters {
           vector[Npreds] beta;
           real<lower=0> sigmalev1;
           real<lower=0> sigmalev2;
           real<lower=0> sigmaeps;

           vector[Nlev1] eta1;
           vector[Nlev2] eta2;
}
transformed parameters {
  vector[Nlev1] ran1;
  vector[Nlev2] ran2;
  vector[Nobs] yhat;

  ran1  <- sigmalev1 * eta1;
  ran2  <- sigmalev2 * eta2;

  for (i in 1:Nobs)
    yhat[i] = x[i]*beta+ran1[levind1[i]]+ran2[levind2[i]];

}
model {
  eta1 ~ normal(0, 1);
  eta2 ~ normal(0, 1);
  sigmalev1 ~ cauchy(0, 2.5*sdscal);
  sigmalev2 ~ cauchy(0, 2.5*sdscal);
  sigmaeps ~ cauchy(0, 2.5*sdscal);
  y ~ normal(yhat, sigmaeps);
}
"
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())
set.seed(123)
fit <- stan(model_code = model_code, data = datdat, verbose=TRUE)
```





## Including Plots

You can also embed plots, for example:




```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
